### 设计背景
网关有对外含有高敏感度的数据信息api(例如楼盘字典信息),为了防止核心数据被非正常拉取,一次需要制定相应的反爬策略,对数据进行保护


### 基本需求
1、访问分为精准控制和动态控制两种方式

2、精准控制: 通过请求url、ip、参数、以及header 组合,满足条件的所有请求直接封禁或者放行（白名单）

3、动态控制: 通过请求频率进行封禁,具体为: 单位时间内单用户对某一接口的请求数达到阈值时进行封禁,可以多个条件组合, 可设置封禁时长

4、动态控制可设置封禁/报警/验证码三种处理方式, 只报警主要用于异常流量告警

### 网关反爬



### 精准控制

   精准访问控制规则由匹配条件、匹配动作构成。在创建规则时，通过设置匹配字段、逻辑符和相应的匹配内容定义匹配条件，并针对符合匹配条件规则的访问请求定义相应的动作。

#### 匹配条件
匹配条件包含匹配字段、逻辑符、匹配内容。

每一条精准访问控制规则中允许设置多个匹配条件组合，且各个条件间是“与”的逻辑关系，即访问请求必须同时满足所有匹配条件才算命中该规则，并执行相应的匹配动作。

### 匹配动作

阻断：阻断命中匹配条件的访问请求。 (黑名单)
放行：放行命中匹配条件的访问请求。 (白名单)

### 规则匹配顺序

如果设置了多条规则，则多条规则间有先后匹配顺序，即访问请求将根据您设定的精准访问控制规则顺序依次进行匹配，顺序较前的精准访问控制规则优先匹配。


### 示例


### 支持的字段列表


| 匹配字段 |字段描述  |适用逻辑符  |
| --- | --- | --- |
| IP | 访问请求的来源IP，支持填写IP或IP段 | 属于、不属于 |
| URL | 访问请求的URL地址 | 包含、不包含 、 等于、不等于 |
| Referer | 访问请求的来源网址，即该访问请求是从哪个页面跳转产生的 | 包含、不包含、等于、不等于 、长度小于、长度等于、长度大于、 不存在|
| User-Agent | 发起访问请求的客户端的浏览器标识、渲染引擎标识和版本信息等浏览器相关信息。 | 包含、不包含、等于、不等于 、长度小于、长度等于、长度大于 |
| Params | 访问请求的URL地址中的参数部分，通常指URL中”?”后面的部分。 | 包含、不包含、等于、不等于 、长度小于、长度等于、长度大于 |
| Cookie | 访问请求中的Cookie信息 | 包含、不包含、等于、不等于 、长度小于、长度等于、长度大于、 不存在 |
| Content-Type | 访问请求指定的响应HTTP内容类型，即MIME类型信息 | 包含、不包含、等于、不等于 、长度小于、长度等于、长度大于 |
| Http-Method | 访问请求的方法，如GET、POST等。	 | 等于、不等于 |

### 动态控制

匹配用户规则、匹配api、频率控制规则和匹配动作 四部分构成

#### 1、用户匹配规则
1. 精确匹配单个用户
2. 通过自定义header字段、参数字段名称匹配用户,可以多个条件组合
3. 例如: 设置header的 qf-userId与companyUuid组合
4. 可选条件: ip、自定义header字段、自动以参数字段

#### 2、匹配api
设置此条规则适用于哪些api, 多选或直接设置服务

#### 3、频率控制规则
 以分钟为单位检测api访问频率,可设置任意分钟数,以及对应的api最大访问次数
 
#### 4、匹配动作

1.触发阈值后相应的动作,分封禁、报警和验证码三种方式

2.选择封禁时可设置封禁时长或永久封禁,触发阈值时封禁并且发送报警

3.选择报警时,不会封禁,只会发送报警信息,并记录访问记录

4.选择验证码,需要前端输入相应的验证码之后才能解封



#### 5、示例
